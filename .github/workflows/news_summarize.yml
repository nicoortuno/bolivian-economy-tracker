name: Summarize news (ML)
on:
  schedule: [{ cron: "12 * * * *" }] 
  workflow_dispatch:

jobs:
  summarize:
    runs-on: ubuntu-latest
    env:
      HF_HOME: ~/.cache/huggingface
      PIP_DISABLE_PIP_VERSION_CHECK: "1"
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip (ML set)
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-ml-${{ runner.os }}-${{ hashFiles('requirements-ml.txt') }}
          restore-keys: |
            pip-ml-${{ runner.os }}-

      - name: Cache Hugging Face models
        uses: actions/cache@v4
        with:
          path: ~/.cache/huggingface
          key: hf-${{ runner.os }}-v1
          restore-keys: |
            hf-${{ runner.os }}-

      - name: Install ML deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-ml.txt
          # Install CPU PyTorch only for this job (smallest wheels)
          pip install --index-url https://download.pytorch.org/whl/cpu torch==2.6.*

      - name: Build summaries parquet
        run: |
          python app/jobs/news/summarize_articles.py

      - name: Export summaries JSON for UI
        run: |
          python app/jobs/news/export_summaries_json.py
