name: Summarize news (ML)

on:
  schedule: [{ cron: "12 * * * *" }]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  summarize:
    runs-on: ubuntu-latest
    env:
      HF_HOME: ~/.cache/huggingface
      PIP_DISABLE_PIP_VERSION_CHECK: "1"
      PIP_NO_CACHE_DIR: "1"

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/lib/android
          sudo apt-get clean
          df -h

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip (ML)
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-ml-${{ runner.os }}-${{ hashFiles('requirements-ml.txt') }}
          restore-keys: |
            pip-ml-${{ runner.os }}-

      - name: Cache Hugging Face models
        uses: actions/cache@v4
        with:
          path: ~/.cache/huggingface
          key: hf-${{ runner.os }}-v1
          restore-keys: |
            hf-${{ runner.os }}-

      - name: Create Torch constraints
        run: |
          cat > constraints-ml.txt << 'EOF'
          torch==2.6.0+cpu
          torchvision==0.21.0+cpu
          torchaudio==2.6.0+cpu
          --find-links https://download.pytorch.org/whl/torch_stable.html
          EOF
          cat constraints-ml.txt

      - name: Install dependencies (CPU-only)
        run: |
          python -m pip install --upgrade pip
          pip install --no-cache-dir -r requirements-ml.txt \
            -c constraints-ml.txt \
            --extra-index-url https://download.pytorch.org/whl/cpu
          df -h

      - name: Summarize & export
        run: |
          python app/jobs/news/summarize_articles.py
          python app/jobs/news/export_summaries_json.py

      - name: Commit and push updated summaries
        env:
          TZ: UTC
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          mkdir -p app/ui/public/api data/curated/news
          git add app/ui/public/api/news_latest.json data/curated/news/news_*.parquet || true
          if ! git diff --cached --quiet; then
            git commit -m "Update news summaries ($(date -u +'%Y-%m-%d %H:%M UTC'))"
            git push
          else
            echo "No changes to commit."
          fi
